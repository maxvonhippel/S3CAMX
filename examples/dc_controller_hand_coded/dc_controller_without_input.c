// Must include controller.h
#include "controller.h"


//ref = [ 0.    0.83  0.45  0.05  0.25 -0.5   1.2   0.05  1.75  0.2 ]

static int ref[1000] = { 
0,    0,    0,    0,    0,    0,    0,    0,    0, 0,    0, 0,    0,    0,
0,    0,    0,    0,    0,    0,    0,    0, 0, 0,    0,    0,    0,    0,
0,    0,    0,    0,    0, 0,    0,    0,    0, 0,    0,    0,    0,    0,
0,    0, 0,    0,    0,    0,    0,    0,    0, 0,    0,    0,    0, 0,    0,
0,    0,    0,    0,    0,    0,    0,    0, 0, 0,    0,    0,    0,    0,
0,    0,    0,    0,    0,    0, 0,    0, 0,    0,    0,    0,    0,    0,
0,    0,    0, 0,    0,    0,    0,    0, 0,    0,    0,    0,    0,    0, 0,
1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160,
1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160,
1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160,
1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160,
1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160,
1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160,
1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160,
1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160, 1160,  630,  630,  630,  630,
630,  630,  630,  630,  630, 630,  630, 630,  630,  630,  630,  630,  630,
630,  630,  630, 630,  630,  630,  630, 630,  630,  630,  630,  630,  630,
630, 630,  630,  630,  630,  630,  630, 630,  630,  630,  630,  630, 630,  630,
630,  630,  630,  630,  630,  630, 630,  630,  630, 630,  630,  630,  630,
630,  630,  630,  630,  630,  630, 630, 630,  630,  630,  630,  630,  630,
630,  630,  630,  630,  630, 630, 630,  630,  630,  630,  630,  630,  630,
630,  630,  630, 630,  630,  630, 630,  630,  630,  630,  630,  630,  630,
630, 630,  630,  630,  750,  750, 750,  750,  750,  750,  750,  750, 750,  750,
750,  750,  750,  750,  750, 750,  750,  750,  750, 750,  750,  750,  750,
750,  750,  750,  750,  750, 750,  750, 750,  750,  750,  750,  750,  750,
750,  750,  750,  750,  750, 750,  750,  750,  750,  750,  750,  750,  750,
750,  750,  750, 750,  750, 750,  750,  750,  750,  750,  750,  750,  750,
750, 750,  750,  750,  750, 750,  750,  750,  750,  750,  750,  750, 750,  750,
750,  750,  750,  750, 750,  750,  750,  750,  750, 750,  750,  750,  750,
750,  750,  750,  750, 750,  750,  750, 750,  750,  750,  750,  350,  350,
350,  350,  350,  350, 350, 350,  350,  350,  350,  350,  350,  350,  350,
350,  350,  350, 350, 350,  350,  350,  350,  350,  350,  350,  350,  350,
350, 350,  350,  350, 350,  350,  350,  350,  350,  350,  350,  350, 350,  350,
350,  350,  350, 350,  350,  350,  350,  350,  350, 350,  350,  350,  350,
350,  350,  350, 350,  350,  350,  350, 350,  350,  350,  350,  350,  350,
350,  350,  350, 350,  350, 350,  350,  350,  350,  350,  350,  350,  350,
350,  350,  350, 350,  350,  350,  350,  350,  350,  350,  350,  350,  350,
350, 350,  350, 350,  350,  350, -700, -700, -700, -700, -700, -700, -700,
-700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700,
-700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700,
-700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700,
-700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700,
-700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700,
-700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700,
-700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700, -700,
-700, -700, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400,
1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400,
1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400,
1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400,
1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400,
1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400,
1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400,
1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400, 1400,   2000,   2000,
2000,   2000, 2000, 2000,   2000,   2000,   2000,   2000,   2000,   2000,   2000,   2000,   2000, 2000,
2000,   2000,   2000, 2000,   2000,   2000,   2000,   2000,   2000,   2000, 2000,   2000,   2000,   2000,
2000,   2000,   2000, 2000,   2000,   2000,   2000, 2000,   2000,   2000,   2000,   2000,   2000,   2000,
2000,   2000,   2000, 2000, 2000,   2000,   2000,   2000,   2000,   2000,   2000,   2000,   2000,   2000,
2000, 2000,   2000, 2000,   2000,   2000,   2000,   2000,   2000,   2000,   2000,   2000, 2000,   2000,
2000,   2000,   2000, 2000,   2000,   2000,   2000,   2000,   2000, 2000,   2000,   2000,   2000,   2000,
2000,   2000,   2000, 2000,   2000,   2000, 2000,   2000,   2000,   2000,   2000,   2000,   2000,   2000,
1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,    264,    264, 264,
264, 264,    264,    264, 264,    264,    264,    264,    264,    264, 264,
264,    264,    264,    264, 264,    264,    264, 264,    264,    264, 264,
264,    264,    264,    264,    264,    264,    264, 264,    264,    264, 264,
264,    264,    264,    264,    264,    264,    264,    264,    264,    264,
264,    264,    264, 264,    264,    264,    264,    264,    264,    264,
264, 264,    264,    264, 264,    264,    264, 264,    264,    264,    264,
264, 264,    264,    264,    264,    264,    264, 264,    264,    264, 264,
264, 264,    264,    264,    264,    264,    264,    264,    264,    264, 264,
264, 264, 264,    264,    264,    264,    264,    264,    264,    264,    264};



#define SAT (20)

void controller_init(){
}

void* controller(INPUT_VAL* input, RETURN_VAL* ret_val)
{       

  int pid_op = 0;
  int KP = 40;
  int KI = 1;
  int error, error_i;

  int y = input->x_arr[0];
  // get the previous error
  int error_i_prev = input->state_arr[0];
  int idx = input->state_arr[2];
  //int ref_val = ref[idx];
  int ref_val = 1000;

  error = ref_val - (y + input->input_arr[0]);
  // to illustrate: ei += e*Ki
  error_i = error * KI + error_i_prev;
  error_i_prev = error_i;

  pid_op = error * KP + error_i * KI;

  if(pid_op > SAT*1000)
    pid_op = SAT*1000;
  else if(pid_op < -SAT*1000)
    pid_op = -SAT*1000;
  else
    pid_op = pid_op;

  ret_val->output_arr[0] = pid_op;
  ret_val->state_arr[0] = error_i_prev;
  ret_val->state_arr[1] = ref_val;
  
  ret_val->state_arr[2] = idx + 1;
//printf("%d\n", idx);
  return (void*)0;
}
